<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>äº’å‹•å¼å‹•è©é…å°éŠæˆ² Ver 6.4 (ä¿®æ­£æ‹¼å­— & å¯¦ä½œåˆ†æ•¸éæ¸›é‚è¼¯)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  /* --- è«è˜­è¿ªè‰²èª¿è¨­å®š (Morandi Palette) --- */
  :root{
    /* æ ¸å¿ƒè‰²èª¿ */
    --morandi-blue: #8DA1B9;       /* éœ§éœ¾è— */
    --morandi-blue-dark: #6D7E92;  /* æ·±éœ§è— */
    --morandi-pink: #D3C4C7;       /* ç…™ç°ç²‰ */
    --morandi-pink-dark: #B8A6AA;  /* æ·±ç…™ç²‰ */
    --morandi-green: #94A89A;      /* é¼ å°¾è‰ç¶  */
    --morandi-beige: #E6E2DD;      /* å¥¶èŒ¶ç±³ç° */
    --morandi-yellow: #E0D8C3;     /* ç‡•éº¥é»ƒ */
    
    /* æ–‡å­—èˆ‡èƒŒæ™¯ - å¼·åŒ–å°æ¯”åº¦ */
    --text-primary: #495057;       /* æ·±ç°è—æ–‡å­— (æ›´æ·±ï¼Œæé«˜é–±è®€æ€§) */
    --text-secondary: #7E8A98;     /* æ·ºç°æ–‡å­— (ç¨æ·±ï¼Œæé«˜æ¨™ç±¤è¾¨è­˜åº¦) */
    --bg: #F2F0EB;                 /* æº«æš–ç±³ç°èƒŒæ™¯ */
    --card-bg: #FCFAF7;            /* å¹¾è¿‘ç™½çš„ç±³è‰²å¡ç‰‡èƒŒæ™¯ */
    --border: #D3D7DD;             /* æŸ”å’Œç°é‚Šæ¡† */
    
    /* åŠŸèƒ½è‰²æ˜ å°„ */
    --accent: var(--morandi-blue);
    --accent-dark: var(--morandi-blue-dark);
    
    --success: #94A89A;            /* é¼ å°¾è‰ç¶  (ç­”å°) */
    --success-bg: #EFF3F1;         /* æ·ºç¶ èƒŒæ™¯ */
    --error: #C48A8A;              /* ç…™ç‡»ç«ç‘°ç´… (ç­”éŒ¯) */
    --error-bg: #F7EEEE;           /* æ·ºç´…èƒŒæ™¯ */
    --verb-highlight: #D9A68C;     /* æŸ”å’Œèµ¤é™¶è‰² */
    
    --drop-zone-bg: #EBEFF2;       /* æ¥µæ·ºç°è— */
    --shadow-color: rgba(95, 107, 117, 0.15); /* æŸ”å’Œæ·±ç°é™°å½± */
  }
  
  body{
    font-family:'Gen Jyuu Gothic', 'Noto Sans TC', Inter, system-ui, sans-serif;
    margin:0; background:var(--bg); color:var(--text-primary);
    line-height: 1.6; padding-bottom: 50px;
  }
  
  .container{
    max-width:1400px; margin:20px auto; padding:24px;
    background:var(--card-bg); border-radius:24px;
    box-shadow:0 15px 35px var(--shadow-color);
    border: 1px solid #FFF;
  }
  
  /* æ¨™é¡Œå€ */
  .header-area { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
  h1{ margin:0; font-size:28px; color: var(--morandi-blue-dark); font-weight: 800; letter-spacing: 1px; }
  .version-badge {
    background: var(--morandi-pink-dark); color: #fff; font-size: 14px;
    padding: 4px 12px; border-radius: 20px; font-weight: 700;
    box-shadow: 2px 2px 5px var(--shadow-color); letter-spacing: 0.5px;
  }
  p.lead{margin:0 0 20px; color:var(--text-secondary); font-size:16px}
  
  /* æ§åˆ¶é¢æ¿ */
  .control-panel {
    display: flex; gap: 20px; padding: 20px; margin-bottom: 24px;
    border: 2px solid var(--border); border-radius: 20px;
    background: #FDFDFB; align-items: flex-start; flex-wrap: wrap; 
    box-shadow: inset 0 0 15px rgba(0,0,0,0.02);
  }
  /* èª¿æ•´ flex-basisï¼Œè®“å‹•è©é¸æ“‡å’ŒæŒ‰éˆ•å€å¡Šä½”ç”¨æ›´å°‘ç©ºé–“ï¼Œè®“è¡¨æ ¼ä½”ç”¨æ›´å¤šç©ºé–“ */
  .control-group { min-width: 150px; } 
  .control-group.verb-select { flex: 1; max-width: 300px; } /* è®“ä¸‹æ‹‰é¸å–®å€å¡Šæœ‰å½ˆæ€§ä½†é™åˆ¶æœ€å¤§å¯¬åº¦ */
  .control-group.verb-table { flex: 2; min-width: 450px; } /* è®“è¡¨æ ¼å€å¡Šæ“´å¤§ */
  .control-group.actions { flex: 0 0 auto; } /* æŒ‰éˆ•å€ä¸ä¼¸ç¸® */

  
  label{display:block;font-size:15px;color:var(--text-primary);margin-bottom:6px;font-weight: 700;}
  select{
    width:100%; padding:10px; border-radius:12px;
    border:2px solid var(--border); font-size:16px; color: var(--text-primary);
    background-color: #fff; cursor: pointer;
    transition: all 0.2s;
  }
  select:focus { outline: none; border-color: var(--morandi-blue); box-shadow: 0 0 0 3px rgba(141, 161, 185, 0.2); }

  /* å‹•è©é¸æ“‡èˆ‡æŒ‰éˆ•çš„ flex å®¹å™¨ */
  .verb-control-box {
      display: flex; 
      gap: 8px; 
      /* ç¢ºä¿ä¸‹æ‹‰é¸å–®èƒ½ç›¡å¯èƒ½æ“´å¤§ */
      width: 100%; 
  }
  .verb-control-box select {
      flex: 1; /* è®“ select ä½”ç”¨æ‰€æœ‰å‰©é¤˜ç©ºé–“ */
  }
  .verb-control-box button {
      flex-shrink: 0; /* æŒ‰éˆ•ä¸å£“ç¸® */
  }


  /* è«è˜­è¿ªæŒ‰éˆ•æ¨£å¼ (æ‰å¹³åŒ–å¸¶æŸ”å’Œé™°å½±) */
  button{
    background: var(--accent); color:white; padding:10px 20px;
    border:none; border-radius:14px; cursor:pointer;
    font-weight: 700; transition: all 0.2s; white-space: nowrap;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transform: translateY(0); letter-spacing: 0.5px;
  }
  button:hover { background-color: var(--accent-dark); transform: translateY(-1px); box-shadow: 0 6px 8px -1px rgba(0, 0, 0, 0.15); }
  button:active { transform: translateY(1px); box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
  
  button#applyVerb { background: var(--morandi-pink-dark); }
  button#applyVerb:hover { background: #A69397; }

  button.secondary{ background: var(--morandi-beige); color: var(--text-primary); box-shadow: none; border: 1px solid var(--border); }
  button.secondary:hover { background: #D8D4CF; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  button.secondary:active { background: #CFCBC6; }

  /* å‹•è©è®ŠåŒ–è¡¨ */
  #verbTable {
    width: 100%; border-collapse: separate; border-spacing: 0; text-align: center;
    background: white; border-radius: 16px; overflow: hidden;
    border: 1px solid var(--border);
    box-shadow: 0 4px 10px var(--shadow-color);
  }
  #verbTable th {
    padding: 12px; background: var(--morandi-blue-dark); color: #f0f0f0;
    font-size: 14px; font-weight: 600; letter-spacing: 1px;
  }
  #verbTable td {
    padding: 12px; font-size: 18px; font-weight: 700;
    color: var(--text-primary); border-bottom: 1px solid var(--border);
    background: #FAFAFA;
  }
  #verbTable tr:last-child td { border-bottom: none; }
  
  /* éŠæˆ²å€åŸŸ */
  .game-layout {
    display: flex; gap: 24px; align-items: flex-start; position: relative;
  }
  .drop-targets {
    flex: 3; display:grid; grid-template-columns: repeat(5, 1fr); gap: 15px;
  }
  /* å¡ç‰‡ä¾†æºå€ (Sticky) - æŸ”å’Œç±³ç²‰è‰² */
  .draggable-sentences {
    flex: 1; min-width: 250px;
    display: flex; flex-direction: column; gap: 12px; padding: 20px;
    background: #F5F2F0; border-radius: 20px; border: 2px dashed var(--morandi-pink);
    position: sticky; top: 20px; max-height: 85vh; overflow-y: auto;
    box-shadow: inset 0 2px 10px rgba(0,0,0,0.03);
  }
  .draggable-sentences::-webkit-scrollbar { width: 6px; }
  .draggable-sentences::-webkit-scrollbar-track { background: transparent; }
  .draggable-sentences::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  /* ç›®æ¨™å€ - æŸ”å’Œç°è— */
  .drop-target {
    border: 2px dashed var(--border); border-radius: 16px; min-height: 120px;
    padding: 10px; text-align: center; background-color: var(--drop-zone-bg);
    transition: all 0.3s ease;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
  }
  .drop-target small {
    color: var(--text-secondary); display:block; margin-bottom: 8px;
    font-size: 14px; 
    font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
  }
  .drop-target.hover { border-color: var(--morandi-blue); background-color: #E3E8EE; transform: scale(1.02); }
  
  /* å³æ™‚å›é¥‹é¡è‰² - è«è˜­è¿ªç‰ˆ */
  .drop-target.correct-feedback { background-color: var(--success-bg); border: 2px solid var(--success); }
  .drop-target.incorrect-feedback { background-color: var(--error-bg); border: 2px solid var(--error); }
  
  .feedback-message { font-size: 15px; font-weight: 700; margin-top: 8px; animation: fadedIn 0.4s; }
  .feedback-message.ok { color: var(--success); }
  .feedback-message.bad { color: var(--error); }
  
  /* æ–°å¢ï¼šåˆ†æ•¸éæ¸›æç¤º */
  .feedback-message .score-hint {
      font-size: 13px;
      font-weight: 500;
      color: var(--morandi-blue-dark);
      margin-left: 5px;
  }

  @keyframes fadedIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

  /* å¥å­å¡ç‰‡ */
  .sentence-card {
    background: #fff; padding: 16px; border-radius: 12px;
    box-shadow: 0 2px 5px var(--shadow-color); cursor: grab;
    border: 1px solid var(--border); 
    font-size: 18px; 
    font-weight: 600;
    line-height: 1.5; transition: all 0.2s; color: var(--text-primary); 
  }
  .sentence-card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px var(--shadow-color); border-color: var(--morandi-blue); }
  .sentence-card:active { cursor: grabbing; transform: translateY(0); }

  .highlight-verb {
    color: var(--verb-highlight); font-weight: 900;
    border-bottom: 2px solid rgba(217, 166, 140, 0.4);
  }
  .tense-group-label {
    grid-column: 1 / -1; font-size: 18px; font-weight: 700; color: var(--text-primary);
    margin: 25px 0 10px; padding-left: 12px; border-left: 4px solid var(--morandi-blue-dark); line-height: 1.2;
    letter-spacing: 1px;
  }

  /* --- æˆç¸¾å–® Modal (è«è˜­è¿ªé¢¨æ ¼) --- */
  #reportCardModal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(50, 55, 60, 0.6); display: none; 
    justify-content: center; align-items: center; z-index: 2000;
    backdrop-filter: blur(5px);
  }
  .report-content {
    background: #FAFAFA; padding: 0; border-radius: 20px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    width: 95%; max-width: 800px; max-height: 95vh;
    overflow-y: auto; color: var(--text-primary);
    display: flex; flex-direction: column; border: 1px solid var(--border);
  }
  
  .report-header-bg {
    background: linear-gradient(135deg, var(--morandi-blue-dark), #7E8C9D); 
    color: #F2F0EB; padding: 25px 35px; border-radius: 20px 20px 0 0;
    display: flex; justify-content: space-between; align-items: center;
  }
  .report-title h2 { margin: 0; font-size: 26px; font-weight: 700; letter-spacing: 1px; }
  
  .student-form {
    display: flex; gap: 20px; padding: 25px 35px;
    background: #fff; border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
  }
  .form-group label { color: var(--text-secondary); }
  .form-group input {
    border: 1px solid var(--border); border-radius: 8px;
    font-family: inherit; color: var(--text-primary); background: #FDFDFB;
  }
  .form-group input:focus { border-color: var(--morandi-blue); box-shadow: 0 0 0 3px rgba(141, 161, 185, 0.1); }

  .export-mode .student-form { background: white; border-bottom: 2px solid var(--morandi-blue-dark); }
  .export-mode .form-group input { border: none; font-size: 20px; color: #333; margin-top: 0; background: transparent; }
  
  .score-section { text-align: center; padding: 30px; background: #FAFAFA; }
  .big-score {
    font-size: 90px; font-weight: 900; line-height: 1;
    color: var(--morandi-blue-dark);
    text-shadow: 2px 2px 0px var(--border);
  }
  .time-display {
    background: var(--morandi-yellow); padding: 6px 16px; border-radius: 20px;
    font-weight: 700; color: #8A8168; display: inline-block; margin-top: 15px; font-size: 14px;
  }

  .result-lists {
    display: flex; gap: 20px; padding: 25px 35px; background: #fff;
  }
  .list-col { flex: 1; }
  .list-title { border-bottom: 2px solid; padding-bottom: 8px; letter-spacing: 0.5px; margin-bottom: 15px; font-weight: 700; font-size: 16px; }
  .correct-col .list-title { color: var(--success); border-color: var(--success); }
  .error-col .list-title { color: var(--error); border-color: var(--error); }

  .result-item { 
    margin-bottom: 10px; padding: 12px; border-radius: 10px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid var(--border); 
    background: #fff; font-size: 14px;
  }
  .result-item.correct { border-left: 5px solid var(--success); background: var(--success-bg); }
  .result-item.wrong { border-left: 5px solid var(--error); background: var(--error-bg); }
  
  /* éŒ¯é¡Œä¿®æ­£è³‡è¨Š */
  .wrong .item-label { color: var(--error); }
  .wrong .score-info { color: var(--error); font-weight: 700; margin-top: 5px; }

  .item-label { color: var(--text-secondary); margin-bottom: 5px; font-size: 13px; }
  .comparison-box { margin-top: 8px; border-top: 1px dashed var(--border); padding-top: 8px; }
  .ans-row { display: flex; align-items: baseline; gap: 10px; margin-bottom: 5px; }
  .ans-tag { 
    font-size: 11px; padding: 2px 6px; border-radius: 4px; color: white; font-weight: 700; 
    letter-spacing: 0.5px;
  }
  .ans-tag.wrong { background: var(--error); }
  .ans-tag.right { background: var(--success); }
  .ans-text.wrong-text { color: var(--error); font-weight: 600; } 
  .ans-text.right-text { color: var(--success); font-weight: 600; }

  .report-footer { 
    background: #fff; padding: 25px 35px; gap: 15px; 
    border-top: 1px solid var(--border); display: flex; justify-content: flex-end;
  }
  
  /* ä¸‹è¼‰æŒ‰éˆ• - è«è˜­è¿ªè‰² */
  .btn-download-pdf { background-color: var(--error); }
  .btn-download-pdf:hover { background-color: #B07878; }
  .btn-download-jpg { background-color: var(--morandi-blue); }
  .btn-download-jpg:hover { background-color: var(--morandi-blue-dark); }

  /* åˆ—å°æ¨£å¼ */
  @media print {
    body > * { display: none; }
    #reportCardModal { display: flex !important; background: white; position: absolute; top:0; left:0; }
    .report-content { box-shadow: none; width: 100%; max-width: 100%; max-height: none; overflow: visible; padding: 0; border: none; background: white; }
    .report-footer { display: none; }
    .student-form { background: white; border-bottom: 2px solid #555; }
    .form-group input { border: none; background: transparent; padding: 0; font-size: 18px; color: black; }
    .result-lists { display: flex; }
    .list-col { margin-bottom: 0; page-break-inside: avoid; }
    .report-header-bg { background: #555; color: white; } 
  }
</style>
</head>
<body>
<div class="container" id="gameContainer">
  <div class="header-area">
    <h1>äº’å‹•å¼å‹•è©é…å°éŠæˆ²</h1>
    <span class="version-badge">Ver 6.4 åˆ†æ•¸éæ¸›é‚è¼¯</span>
  </div>
  <p class="lead">å°‡å¥å­æ‹–æ›³åˆ°å°æ‡‰çš„æ™‚æ…‹èˆ‡å¥å‹åˆ†é¡ä¸­ã€‚éŒ¯èª¤é…å°å¾Œé‡é…ï¼Œåˆ†æ•¸å°‡éæ¸›ã€‚</p>

  <div class="control-panel">
    
    <div class="control-group verb-select">
      <label>é¸æ“‡å‹•è© (åŠç‰©å‹•è©)</label>
      <div class="verb-control-box">
        <select id="verbSelect"></select>
        <button id="applyVerb">æ›´æ›é¡Œç›® (é–‹å§‹è¨ˆæ™‚)</button>
      </div>
    </div>

    <div class="control-group verb-table"> 
      <label>å‹•è©ä¸‰æ…‹è®ŠåŒ–è¡¨</label>
      <table id="verbTable"></table>
      <input type="hidden" id="base"><input type="hidden" id="past"><input type="hidden" id="pastPart"><input type="hidden" id="ing">
    </div>
    
    <div class="control-group actions">
      <label>åŠŸèƒ½æ“ä½œ</label>
      <div style="display:flex; gap:10px;">
        <button id="generateReportButton">æˆç¸¾çµç®—</button>
        <button id="resetGame" class="secondary">é‡è¨­éŠæˆ²</button>
      </div>
    </div>
  </div>

  <div class="game-layout">
    <div class="drop-targets" id="dropTargets"></div>
    <div class="draggable-sentences" id="draggableSentences">
      <div style="text-align:center; padding: 40px 10px; color:var(--text-secondary);">
        <p>æº–å‚™å¥½é–‹å§‹äº†å—ï¼Ÿ</p>
        <p>é»æ“Šä¸Šæ–¹ <strong>ã€Œæ›´æ›é¡Œç›®ã€</strong> ç”Ÿæˆäº‚æ•¸å¡ç‰‡</p>
      </div>
    </div>
  </div>

  <div style="font-size:15px; color:var(--text-secondary); margin-top:24px; text-align:center; border-top:1px solid var(--border); padding-top:16px;" id="status">
    è«‹é¸æ“‡å‹•è©ä¸¦é–‹å§‹ç·´ç¿’ã€‚
  </div>
</div>

<div id="reportCardModal">
    <div class="report-content" id="reportContentToCapture">
        <div class="report-header-bg">
            <div class="report-title">
                <h2>å¥å­é…å°ç·´ç¿’æˆç¸¾å–®</h2>
                <p>ç·´ç¿’ä¸»é¡Œ: å‹•è©æ™‚æ…‹èˆ‡ä¸»è¢«å‹•è®ŠåŒ–</p>
            </div>
            <div style="text-align:right;">
                <div style="font-size:12px; opacity:0.9;">ç·´ç¿’å‹•è©</div>
                <div style="font-size:24px; font-weight:800; text-transform:uppercase; letter-spacing:1px;" id="reportVerb"></div>
            </div>
        </div>
        
        <div class="student-form" id="studentFormArea">
            <div class="form-group">
                <label>ç­ç´š (Class)</label>
                <input type="text" id="inputClass" placeholder="ä¾‹: é«˜ä¸€ç”²">
            </div>
            <div class="form-group">
                <label>åº§è™Ÿ (No.)</label>
                <input type="text" id="inputID" placeholder="ä¾‹: 01">
            </div>
            <div class="form-group" style="flex:2;">
                <label>å§“å (Name)</label>
                <input type="text" id="inputName" placeholder="è«‹è¼¸å…¥å§“å">
            </div>
        </div>

        <div class="score-section">
            <div class="score-label">TOTAL SCORE</div>
            <div class="big-score"><span id="finalScore">0</span></div>
            
            <div style="margin-top: 15px; display:flex; justify-content:center; gap:20px; align-items:center;">
                <div style="color:var(--text-primary); font-size:15px; font-weight: 600;">
                    åŸå§‹ç¸½åˆ†: <span id="maxScoreDisplay" style="font-weight:bold;">15</span> é¡Œ (100åˆ†)
                </div>
                <div class="time-display">
                    â±ï¸ ç­”é¡Œæ™‚é–“: <span id="timeTakenDisplay">00:00</span>
                </div>
            </div>
        </div>

        <div class="result-lists">
            <div class="list-col correct-col">
                <div class="list-title">
                    <span>ğŸŸ¢ ç­”å°é¡Œç›® (é¦–æ¬¡æ­£ç¢º)</span>
                    <span style="font-size:12px; opacity:0.8;">(Correct)</span>
                </div>
                <div id="correctListContainer"></div>
            </div>

            <div class="list-col error-col">
                <div class="list-title">
                    <span>ğŸ”´ éŒ¯èª¤èˆ‡è¨‚æ­£ (å«åˆ†æ•¸éæ¸›)</span>
                    <span style="font-size:12px; opacity:0.8;">(Corrections)</span>
                </div>
                <div id="errorListContainer"></div>
            </div>
        </div>

        <div class="report-footer" data-html2canvas-ignore="true">
            <button onclick="downloadJPG()" class="btn-download-jpg">ä¸‹è¼‰ JPG åœ–ç‰‡</button>
            <button onclick="downloadPDF()" class="btn-download-pdf">ä¸‹è¼‰ PDF æ–‡ä»¶</button>
            <button onclick="closeReport()" class="secondary">é—œé–‰è¦–çª—</button>
        </div>
    </div>
</div>

<script>
// --- éŸ³æ•ˆç³»çµ± (Web Audio API) ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSound(type) {
    if (audioCtx.state === 'suspended') { audioCtx.resume(); }
    const osc = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    
    osc.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    
    const now = audioCtx.currentTime;
    
    if (type === 'correct') {
        // å®å’šè² (æŸ”å’Œé«˜é »)
        osc.type = 'sine';
        osc.frequency.setValueAtTime(600, now);
        osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
        gainNode.gain.setValueAtTime(0.1, now); // éŸ³é‡é€²ä¸€æ­¥é™ä½
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
        osc.start(now);
        osc.stop(now + 0.4);
    } else {
        // å—¡å—¡è² (æŸ”å’Œä½é »)
        osc.type = 'triangle'; 
        osc.frequency.setValueAtTime(180, now);
        osc.frequency.linearRampToValueAtTime(120, now + 0.3);
        gainNode.gain.setValueAtTime(0.1, now); // éŸ³é‡é€²ä¸€æ­¥é™ä½
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        osc.start(now);
        osc.stop(now + 0.3);
    }
}

// --- è¨ˆæ™‚å™¨è®Šæ•¸ ---
let startTime = null;
let endTime = null;

const templates = [
  {row:'Present',col:'Simple', label_zh:'ç¾åœ¨ ç°¡å–®å¼'},{row:'Present',col:'Continuous', label_zh:'ç¾åœ¨ é€²è¡Œå¼'},{row:'Present',col:'Perfect', label_zh:'ç¾åœ¨ å®Œæˆå¼'},{row:'Present',col:'PerfCont', label_zh:'ç¾åœ¨ å®Œæˆé€²è¡Œå¼'},{row:'Present',col:'Passive', label_zh:'ç¾åœ¨ è¢«å‹•å¼'},
  {row:'Past',col:'Simple', label_zh:'éå» ç°¡å–®å¼'},{row:'Past',col:'Continuous', label_zh:'éå» é€²è¡Œå¼'},{row:'Past',col:'Perfect', label_zh:'éå» å®Œæˆå¼'},{row:'Past',col:'PerfCont', label_zh:'éå» å®Œæˆé€²è¡Œå¼'},{row:'Past',col:'Passive', label_zh:'éå» è¢«å‹•å¼'},
  {row:'Future',col:'Simple', label_zh:'æœªä¾† ç°¡å–®å¼'},{row:'Future',col:'Continuous', label_zh:'æœªä¾† é€²è¡Œå¼'},{row:'Future',col:'Perfect', label_zh:'æœªä¾† å®Œæˆå¼'},{row:'Future',col:'PerfCont', label_zh:'æœªä¾† å®Œæˆé€²è¡Œå¼'},{row:'Future',col:'Passive', label_zh:'æœªä¾† è¢«å‹•å¼'}
];

const verbs = {
  eat:  {base:'eat', past:'ate', pp:'eaten', ing:'eating', object:'a sandwich'},
  write:{base:'write', past:'wrote', pp:'written', ing:'writing', object:'a letter'},
  read: {base:'read', past:'read', pp:'read', ing:'reading', object:'a book'},
  do:   {base:'do', past:'did', pp:'done', ing:'doing', object:'homework'},
  make: {base:'make', past:'made', pp:'made', ing:'making', object:'a cake'},
  take: {base:'take', past:'took', pp:'taken', ing:'taking', object:'a photo'},
  see:  {base:'see', past:'saw', pp:'seen', ing:'seeing', object:'a bird'},
  catch:{base:'catch', past:'caught', pp:'caught', ing:'catching', object:'the ball'},
  wash: {base:'wash', past:'washed', pp:'washed', ing:'washing', object:'the car'},
  clean:{base:'clean', past:'cleaned', pp:'cleaned', ing:'cleaning', object:'the room'},
  open: {base:'open', past:'opened', pp:'opened', ing:'opening', object:'the box'},
  close:{base:'close', past:'closed', pp:'closed', ing:'closing', object:'the door'},
  buy:  {base:'buy', past:'bought', pp:'bought', ing:'buying', object:'a gift'},
  fix:  {base:'fix', past:'fixed', pp:'fixed', ing:'fixing', object:'the toy'},
  drink:{base:'drink', past:'drank', pp:'drunk', ing:'drinking', object:'the juice'},
  teach:{base:'teach', past:'taught', pp:'taught', ing:'teaching', object:'English'},
  paint:{base:'paint', past:'painted', pp:'painted', ing:'painting', object:'the wall'},
  love: {base:'love', past:'loved', pp:'loved', ing:'loving', object:'the dog'},
  help: {base:'help', past:'helped', pp:'helped', ing:'helping', object:'people'},
  find: {base:'find', past:'found', pp:'found', ing:'finding', object:'the key'}
};

let current = verbs.eat; 
let sentenceData = [];

// *** æ–°å¢ï¼šè¿½è¹¤æ¯å¼µå¡ç‰‡çš„ç‹€æ…‹ ***
let cardState = {}; // { sentenceId: { attempts: 0, initialError: false, isCorrect: false } }

const row_zh = {'Present':'ç¾åœ¨å¼', 'Past':'éå»å¼', 'Future':'æœªä¾†å¼'};
const col_zh = {'Simple':'ç°¡å–®å¼', 'Continuous':'é€²è¡Œå¼', 'Perfect':'å®Œæˆå¼', 'PerfCont':'å®Œæˆé€²è¡Œå¼', 'Passive':'è¢«å‹•å¼'};

function highlight(text) {
    return `<span class="highlight-verb">${text}</span>`;
}

function sample(i, verbContext = current){
  const t = templates[i];
  const o = verbContext.object; 
  const {base: b, past: p, pp, ing} = verbContext;
  
  const objectCap = o.charAt(0).toUpperCase() + o.slice(1);
  const subject = 'He';
  
  const isPlural = o.toLowerCase().endsWith('s') && !o.endsWith('ss'); 
  
  if (t.col === 'Passive') {
    let beForm = '';

    if(t.row==='Present') {
      if(t.col==='Passive'){
        beForm = isPlural ? 'are' : 'is';
        return`${objectCap} ${highlight(`${beForm} ${pp}`)}.`;
      }
    }
    else if(t.row==='Past') {
      if(t.col==='Passive'){
        beForm = isPlural ? 'were' : 'was';
        return`${objectCap} ${highlight(`${beForm} ${pp}`)}.`;
      }
    }
    
    // Future Passive
    if(t.row==='Future' && t.col==='Passive') {
        return`${objectCap} ${highlight(`will be ${pp}`)}.`;
    }
  }

  // Active Voice
  if(t.col==='Simple'){
    if(t.row==='Present') {
        // *** ä¿®æ­£ï¼šè™•ç† do/does æ‹¼å¯«éŒ¯èª¤ ***
        if (b === 'do') {
            return`${subject} ${highlight(`does`)} ${o}.`;
        }
        return`${subject} ${highlight(`${b}s`)} ${o}.`;
    }
    if(t.row==='Past')return`${subject} ${highlight(p)} ${o}.`;
    return`${subject} ${highlight(`will ${b}`)} ${o}.`;
  }
  if(t.col==='Continuous'){
    if(t.row==='Present')return`${subject} ${highlight(`is ${ing}`)} ${o}.`;
    if(t.row==='Past')return`${subject} ${highlight(`was ${ing}`)} ${o}.`;
    return`${subject} ${highlight(`will be ${ing}`)} ${o}.`;
  }
  if(t.col==='Perfect'){
    if(t.row==='Present')return`${subject} ${highlight(`has ${pp}`)} ${o}.`;
    if(t.row==='Past')return`${subject} ${highlight(`had ${pp}`)} ${o}.`;
    return`${subject} ${highlight(`will have ${pp}`)} ${o}.`;
  }
  if(t.col==='PerfCont'){
    if(t.row==='Present')return`${subject} ${highlight(`has been ${ing}`)} ${o}.`;
    if(t.row==='Past')return`${subject} ${highlight(`had been ${ing}`)} ${o}.`;
    return`${subject} ${highlight(`will have been ${ing}`)} ${o}.`;
  }
}

function updateVerbTable(verb) {
    const table = document.getElementById('verbTable');
    table.innerHTML = `
        <thead>
            <tr><th>åŸå‹ (Base)</th><th>éå»å¼ (Past)</th><th>éå»åˆ†è© (P.P.)</th><th>ç¾åœ¨åˆ†è© (V-ing)</th></tr>
        </thead>
        <tbody>
            <tr><td>${verb.base}</td><td>${verb.past}</td><td>${verb.pp}</td><td>${verb.ing}</td></tr>
        </tbody>
    `;
    document.getElementById('base').value=verb.base;
    document.getElementById('past').value=verb.past;
    document.getElementById('pastPart').value=verb.pp;
    document.getElementById('ing').value=verb.ing;
}

function fillVerbSelect() {
    const select = document.getElementById('verbSelect');
    select.innerHTML = '';
    const verbKeys = Object.keys(verbs).sort();
    verbKeys.forEach(key => {
        const v = verbs[key];
        const option = document.createElement('option');
        option.value = key;
        option.textContent = `${key} (${v.object})`;
        select.appendChild(option);
    });
}
fillVerbSelect(); 

function buildDropTargets(){
  const dropTargets=document.getElementById('dropTargets');
  dropTargets.innerHTML='';
  let lastRow = '';
  templates.forEach((t,i)=>{
    if (t.row !== lastRow) {
        const labelDiv = document.createElement('div');
        labelDiv.className = 'tense-group-label';
        labelDiv.textContent = row_zh[t.row];
        dropTargets.appendChild(labelDiv);
        lastRow = t.row;
    }
    const div=document.createElement('div');
    div.className='drop-target';
    div.setAttribute('data-target-id', i);
    div.innerHTML=`<small>${col_zh[t.col]} (${row_zh[t.row]})</small>`; 
    // *** æ–°å¢ï¼šç›®æ¨™å€è¿½è¹¤å¡ç‰‡ IDï¼Œç”¨æ–¼åˆ†æ•¸è¨ˆç®—æ™‚å›æŸ¥ç‹€æ…‹ ***
    div.setAttribute('data-card-id', ''); 
    dropTargets.appendChild(div);
  });
}

function buildDraggableSentences(){
  const draggableSentences=document.getElementById('draggableSentences');
  draggableSentences.innerHTML='';
  sentenceData = [];
  cardState = {}; // é‡è¨­å¡ç‰‡ç‹€æ…‹

  for(let i=0; i<templates.length; i++){
    sentenceData.push({
      id: i,
      sentence: sample(i), 
      correctTargetId: i,
      // *** åˆå§‹åŒ–å¡ç‰‡ç‹€æ…‹ ***
      attempts: 0,
      initialError: false, 
      isCorrect: false
    });
    // å„²å­˜åˆ°å…¨åŸŸç‹€æ…‹è¿½è¹¤å™¨
    cardState[i] = { attempts: 0, initialError: false, isCorrect: false };
  }

  sentenceData.sort(() => 0.5 - Math.random());

  sentenceData.forEach((data)=>{
    const div = document.createElement('div');
    div.className = 'sentence-card';
    div.setAttribute('draggable', 'true');
    div.setAttribute('data-sentence-id', data.id); 
    div.innerHTML = data.sentence; 
    draggableSentences.appendChild(div);
  });

  attachDragListeners();
}

function applyVerb(){
  const v=document.getElementById('verbSelect').value;
  current = verbs[v];
  updateVerbTable(current); 
  buildDropTargets();
  buildDraggableSentences(); 
  
  // é‡ç½®ä¸¦é–‹å§‹è¨ˆæ™‚
  startTime = Date.now();
  endTime = null;
  
  document.getElementById('status').textContent=`å·²é¸æ“‡ï¼š${current.base}ã€‚è¨ˆæ™‚é–‹å§‹ï¼è«‹æ‹–æ›³å¥å­å¡ç‰‡ã€‚`;
}

document.getElementById('applyVerb').onclick=applyVerb;
document.getElementById('resetGame').onclick=applyVerb; 

// --- Drag & Drop ---
let draggedItem = null;
function handleDragStart(e) {
  draggedItem = e.target;
  e.dataTransfer.setData('text/plain', e.target.getAttribute('data-sentence-id'));
  setTimeout(() => e.target.classList.add('dragged'), 0);
  
  // ç´€éŒ„å¡ç‰‡å¾å“ªå€‹ç›®æ¨™å€è¢«æ‹–å‡º (å¦‚æœæœ‰çš„è©±)
  const parent = draggedItem.parentNode;
  if(parent && parent.classList.contains('drop-target')) {
    parent.setAttribute('data-card-id', ''); // æ¸…é™¤ç›®æ¨™å€ç´€éŒ„
    removeFeedback(parent); // æ¸…é™¤å›é¥‹
  }
}
function handleDragEnd(e) {
  e.target.classList.remove('dragged');
  draggedItem = null;
}
function handleDragOver(e) {
  e.preventDefault();
  const targetElement = e.target.closest('.drop-target');
  if (targetElement && !targetElement.querySelector('.sentence-card')) {
     targetElement.classList.add('hover');
  }
}
function handleDragLeave(e) {
  e.target.closest('.drop-target')?.classList.remove('hover');
}
function removeFeedback(element) {
    if (element && element.classList.contains('drop-target')) {
        element.classList.remove('correct-feedback', 'incorrect-feedback');
        let oldFeedback = element.querySelector('.feedback-message');
        if (oldFeedback) oldFeedback.remove();
    }
}

function getScoreHint(attempts) {
    if (attempts === 0) return ' (é¦–æ¬¡é…å°)';
    const scoreFraction = 1 / (attempts + 1);
    const scorePercent = Math.round(scoreFraction * 100);
    return ` (ä¿®æ­£ï¼Œæœ¬æ¬¡å¾—åˆ†: ${scorePercent}%)`;
}

function handleDrop(e) {
  e.preventDefault();
  const targetElement = e.target.closest('.drop-target');
  if (!targetElement) return;
  targetElement.classList.remove('hover');
  if (targetElement.querySelector('.sentence-card')) return; 

  if (draggedItem) {
    const droppedSentenceId = parseInt(draggedItem.getAttribute('data-sentence-id'));
    const targetId = parseInt(targetElement.getAttribute('data-target-id'));

    // æ¸…é™¤åŸä½ç½®çš„å›é¥‹ (å¦‚æœå¡ç‰‡æ˜¯å¾ä¾†æºå€æ‹–ä¾†ï¼Œé€™è£¡ä¸æœƒæœ‰æ•ˆæœ)
    removeFeedback(draggedItem.parentNode); 
    
    // åŸ·è¡Œç§»å‹•
    targetElement.appendChild(draggedItem);
    targetElement.setAttribute('data-card-id', droppedSentenceId); // ç´€éŒ„å¡ç‰‡ ID

    // *** æ›´æ–°å¡ç‰‡ç‹€æ…‹å’Œå›é¥‹é‚è¼¯ ***
    const state = cardState[droppedSentenceId];
    state.attempts++; // ç§»å‹•æ¬¡æ•¸ +1 (ç›¸ç•¶æ–¼é…å°æ¬¡æ•¸)
    
    removeFeedback(targetElement); 
    const feedback = document.createElement('div');
    feedback.className = 'feedback-message';

    if (droppedSentenceId === targetId) {
      targetElement.classList.add('correct-feedback');
      feedback.textContent = 'âœ“ æ­£ç¢º';
      feedback.classList.add('ok');
      feedback.innerHTML += `<span class="score-hint">${getScoreHint(state.attempts - 1)}</span>`; // ç¬¬ä¸€æ¬¡ç§»å‹• attempts=1, attempts-1=0
      
      // é¦–æ¬¡ç­”éŒ¯å¾Œï¼Œå†ç­”å°ï¼Œæ‰è¨ˆç®—å¾—åˆ†éæ¸›
      if (state.attempts > 1) {
          state.initialError = true;
      }
      state.isCorrect = true;
      playSound('correct'); 
    } else {
      targetElement.classList.add('incorrect-feedback');
      feedback.textContent = 'âœ— éŒ¯èª¤';
      feedback.classList.add('bad');
      feedback.innerHTML += `<span class="score-hint"> (è«‹é‡æ–°æ‹–æ›³è‡³æ­£ç¢ºä½ç½®)</span>`;
      
      state.initialError = true; // åªè¦éŒ¯éä¸€æ¬¡ï¼Œå°±ç®—æœ‰éŒ¯èª¤ç´€éŒ„
      state.isCorrect = false;
      playSound('incorrect');
    }
    
    targetElement.appendChild(feedback);
    updateScoreDisplay();
  }
}

document.getElementById('draggableSentences').addEventListener('dragover', (e) => {e.preventDefault();});
document.getElementById('draggableSentences').addEventListener('drop', (e) => {
    e.preventDefault();
    if (draggedItem && draggedItem.classList.contains('sentence-card')) {
        const droppedSentenceId = parseInt(draggedItem.getAttribute('data-sentence-id'));
        const parent = draggedItem.parentNode;
        
        // å¦‚æœæ˜¯å¾ç›®æ¨™å€æ‹–å›ä¾†æºå€
        if(parent && parent.classList.contains('drop-target')) {
            parent.setAttribute('data-card-id', ''); // æ¸…é™¤ç›®æ¨™å€ç´€éŒ„
            removeFeedback(parent); // æ¸…é™¤å›é¥‹
            cardState[droppedSentenceId].isCorrect = false; // æ‹–å‡ºå¾Œï¼Œç‹€æ…‹æ”¹ç‚ºæœªå®Œæˆ
        }

        e.currentTarget.appendChild(draggedItem);
        updateScoreDisplay();
    }
});

function attachDragListeners() {
  document.querySelectorAll('.sentence-card').forEach(card => {
    card.addEventListener('dragstart', handleDragStart);
    card.addEventListener('dragend', handleDragEnd);
  });
  document.querySelectorAll('.drop-target').forEach(target => {
    target.addEventListener('dragover', handleDragOver);
    target.addEventListener('dragleave', handleDragLeave);
    target.addEventListener('drop', handleDrop);
  });
}
function updateScoreDisplay() {
    let correctCount = 0;
    document.querySelectorAll('.drop-target').forEach(target => {
        if (target.classList.contains('correct-feedback')) correctCount++;
    });
    document.getElementById('status').textContent = `ç•¶å‰é€²åº¦ï¼šå·²å®Œæˆ ${correctCount}/${templates.length} å¥é…å°ã€‚`;
}

// --- Report Card Logic ---
document.getElementById('generateReportButton').onclick = generateReportCard;

function generateReportCard() {
    // åœæ­¢è¨ˆæ™‚
    if(!endTime) endTime = Date.now();
    const duration = Math.floor((endTime - startTime) / 1000); // seconds
    const minutes = Math.floor(duration / 60).toString().padStart(2, '0');
    const seconds = (duration % 60).toString().padStart(2, '0');
    
    // è¼‰å…¥è³‡æ–™
    document.getElementById('inputClass').value = localStorage.getItem('studentClass') || '';
    document.getElementById('inputID').value = localStorage.getItem('studentID') || '';
    document.getElementById('inputName').value = localStorage.getItem('studentName') || '';

    let totalScoreValue = 0;
    let correctCount = 0;
    const totalCount = templates.length;
    const scorePerItem = 100 / totalCount;

    let initialCorrectListHTML = '';
    let errorListHTML = '';
    
    document.querySelectorAll('.drop-targets .drop-target').forEach(target => {
        const cardId = parseInt(target.getAttribute('data-card-id'));
        const targetId = parseInt(target.getAttribute('data-target-id'));
        const targetLabel = target.querySelector('small').textContent;
        const correctSentence = sample(targetId).replace(/<[^>]*>/g, ''); 
        
        const state = cardId in cardState ? cardState[cardId] : { attempts: 0, initialError: false, isCorrect: false };
        const cardElement = target.querySelector('.sentence-card');

        // 1. æœªä½œç­”æƒ…æ³
        if (!cardElement) {
            errorListHTML += `
                <div class="result-item wrong">
                    <div class="item-label">${targetLabel} (æœªä½œç­”)</div>
                    <div class="score-info">å¾—åˆ†: 0%</div>
                    <div class="comparison-box">
                        <div class="ans-row">
                            <span class="ans-tag right">æ­£ç¢ºç­”æ¡ˆ</span>
                            <span class="ans-text right-text">${correctSentence}</span>
                        </div>
                    </div>
                </div>
            `;
            return;
        }
        
        const studentAns = cardElement.textContent.trim();
        let scorePercent = 0;

        // 2. æœ€çµ‚é…å°æ­£ç¢º
        if (cardId === targetId) {
            
            // è¨ˆç®—å¾—åˆ†ç™¾åˆ†æ¯” (ç¬¬ä¸€æ¬¡å˜—è©¦ attempts=1 -> 100%; ç¬¬äºŒæ¬¡å˜—è©¦ attempts=2 -> 50%)
            const scoreFraction = 1 / state.attempts;
            scorePercent = Math.round(scoreFraction * 100);
            totalScoreValue += scorePerItem * scoreFraction;

            if (state.attempts === 1) {
                // é¦–æ¬¡ç­”å° (100% å¾—åˆ†) -> æ­¸é¡åœ¨ã€Œé¦–æ¬¡æ­£ç¢ºã€å€
                correctCount++;
                initialCorrectListHTML += `
                    <div class="result-item correct">
                        <div class="item-label">${targetLabel}</div>
                        <div style="font-weight:600;">${studentAns}</div>
                    </div>
                `;
            } else {
                // å¤šæ¬¡å˜—è©¦å¾Œç­”å° (åˆ†æ•¸éæ¸›) -> æ­¸é¡åœ¨ã€ŒéŒ¯èª¤èˆ‡è¨‚æ­£ã€å€
                errorListHTML += `
                    <div class="result-item wrong">
                        <div class="item-label">${targetLabel}</div>
                        <div class="score-info">ä¿®æ­£å¾Œç­”å°ã€‚å¾—åˆ†: ${scorePercent}% (å˜—è©¦ ${state.attempts} æ¬¡)</div>
                        <div class="comparison-box">
                            <div class="ans-row">
                                <span class="ans-tag right">æ­£ç¢ºç­”æ¡ˆ</span>
                                <span class="ans-text right-text">${correctSentence}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        } 
        // 3. æœ€çµ‚é…å°éŒ¯èª¤
        else {
            // ç­”éŒ¯ï¼Œå¾—åˆ† 0%
            totalScoreValue += 0;
            errorListHTML += `
                <div class="result-item wrong">
                    <div class="item-label">${targetLabel}</div>
                    <div class="score-info">æœ€çµ‚ç­”æ¡ˆéŒ¯èª¤ã€‚å¾—åˆ†: 0%</div>
                    <div class="comparison-box">
                        <div class="ans-row">
                            <span class="ans-tag wrong">ä½ çš„ç­”æ¡ˆ</span>
                            <span class="ans-text wrong-text">${studentAns}</span>
                        </div>
                        <div class="ans-row">
                            <span class="ans-tag right">æ­£ç¢ºç­”æ¡ˆ</span>
                            <span class="ans-text right-text">${correctSentence}</span>
                        </div>
                    </div>
                </div>
            `;
        }
    });

    const finalScore = Math.round(totalScoreValue);

    document.getElementById('reportVerb').textContent = current.base;
    document.getElementById('finalScore').textContent = finalScore;
    document.getElementById('maxScoreDisplay').textContent = `${totalCount} é¡Œ (100åˆ†ï¼Œæ¯é¡Œç´„ ${Math.round(scorePerItem)} åˆ†)`;
    document.getElementById('timeTakenDisplay').textContent = `${minutes}:${seconds}`;

    document.getElementById('correctListContainer').innerHTML = initialCorrectListHTML || '<div style="color:var(--text-secondary); font-size:14px;">ç„¡é¦–æ¬¡æ­£ç¢ºé¡Œç›®</div>';
    document.getElementById('errorListContainer').innerHTML = errorListHTML || '<div style="color:var(--success); font-weight:bold;">å¤ªæ£’äº†ï¼æ‰€æœ‰é¡Œç›®å‡é¦–æ¬¡æ­£ç¢ºï¼</div>';

    document.getElementById('reportCardModal').style.display = 'flex';
}

function getFilename(ext) {
    const cls = document.getElementById('inputClass').value.trim() || 'Class';
    const name = document.getElementById('inputName').value.trim() || 'Name';
    const id = document.getElementById('inputID').value.trim() || 'No';
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}${month}${day}-${cls}-${name}-${id}.${ext}`;
}

function prepareForExport() {
    const content = document.querySelector('.report-content');
    content.classList.add('export-mode');
    content.style.overflow = 'visible'; 
    content.style.maxHeight = 'none';
}

function resetAfterExport() {
    const content = document.querySelector('.report-content');
    content.classList.remove('export-mode');
    content.style.overflow = 'auto';
    content.style.maxHeight = '95vh';
}

function downloadJPG() {
    prepareForExport();
    const element = document.querySelector('#reportContentToCapture');
    const footer = document.querySelector('.report-footer');
    footer.style.display = 'none';

    html2canvas(element, { scale: 2 }).then(canvas => {
        const link = document.createElement('a');
        link.download = getFilename('jpg');
        link.href = canvas.toDataURL('image/jpeg', 0.9);
        link.click();
        footer.style.display = 'flex';
        resetAfterExport();
    });
}

function downloadPDF() {
    prepareForExport();
    const element = document.querySelector('#reportContentToCapture');
    const footer = document.querySelector('.report-footer');
    footer.style.display = 'none';

    html2canvas(element, { scale: 2 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(getFilename('pdf'));
        footer.style.display = 'flex';
        resetAfterExport();
    });
}

function closeReport() {
    localStorage.setItem('studentClass', document.getElementById('inputClass').value);
    localStorage.setItem('studentID', document.getElementById('inputID').value);
    localStorage.setItem('studentName', document.getElementById('inputName').value);
    document.getElementById('reportCardModal').style.display = 'none';
}

// ç¢ºä¿åˆå§‹è¼‰å…¥æ™‚æœ‰è¡¨æ ¼å’Œå¡ç‰‡
applyVerb(); 
</script>
</body>
</html>